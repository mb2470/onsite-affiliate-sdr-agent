// Add this state variable with the other useState declarations (around line 16):
const [contacts, setContacts] = useState([]);
const [isLoadingContacts, setIsLoadingContacts] = useState(false);
const [selectedContact, setSelectedContact] = useState(null);

// Add this function after the enrichLead function (around line 500):

// Find contacts using Apollo.io
const findContacts = async (lead) => {
  setIsLoadingContacts(true);
  setContacts([]);
  
  try {
    console.log(`Finding contacts for: ${lead.website}`);

    const response = await fetch('/.netlify/functions/apollo-contacts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        website: lead.website,
        titles: [
          'VP Digital Marketing',
          'Director Digital Marketing',
          'VP Marketing',
          'Director Marketing',
          'VP Ecommerce',
          'Director Ecommerce',
          'CMO',
          'Chief Marketing Officer',
          'Head of Digital',
          'Head of Ecommerce'
        ]
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to find contacts');
    }

    const data = await response.json();
    
    if (data.contacts && data.contacts.length > 0) {
      setContacts(data.contacts);
      console.log(`Found ${data.contacts.length} contacts`);
    } else {
      alert('No contacts found with verified emails. Try a different search or check Apollo.io credits.');
    }

  } catch (error) {
    console.error('Error finding contacts:', error);
    alert(`Failed to find contacts: ${error.message}. Make sure your Apollo API key is set in Netlify.`);
  } finally {
    setIsLoadingContacts(false);
  }
};

// Select a contact and personalize the email
const selectContact = (contact) => {
  setSelectedContact(contact);
  
  // Personalize the generated email with contact's name
  if (generatedEmail) {
    const personalizedEmail = generatedEmail.replace(
      /Hi there|Hello|Greetings/gi,
      `Hi ${contact.firstName || contact.name.split(' ')[0]}`
    );
    setGeneratedEmail(personalizedEmail);
  }
};

// ADD THIS UI SECTION in the email-generator section, after the generated email block:
// Insert after the closing </div> of generated-email (around line 850)

{generatedEmail && (
  <div className="contact-finder">
    <div className="contact-finder-header">
      <h3>ğŸ¯ Find Decision Maker</h3>
      <button 
        className="find-contacts-btn"
        onClick={() => findContacts(selectedLead)}
        disabled={isLoadingContacts}
      >
        {isLoadingContacts ? 'ğŸ” Searching...' : 'ğŸ” Find Contacts (Apollo.io)'}
      </button>
    </div>

    {contacts.length > 0 && (
      <div className="contacts-list">
        <p className="contacts-count">Found {contacts.length} decision makers:</p>
        {contacts.map((contact) => (
          <div 
            key={contact.id} 
            className={`contact-card ${selectedContact?.id === contact.id ? 'selected' : ''}`}
          >
            <div className="contact-info">
              {contact.photoUrl && (
                <img 
                  src={contact.photoUrl} 
                  alt={contact.name}
                  className="contact-photo"
                />
              )}
              <div className="contact-details">
                <h4>{contact.name}</h4>
                <p className="contact-title">{contact.title}</p>
                <div className="contact-meta">
                  <span className="contact-email">
                    âœ‰ï¸ {contact.email}
                    {contact.emailStatus === 'verified' && (
                      <span className="verified-badge">âœ“ Verified</span>
                    )}
                  </span>
                  {contact.linkedinUrl && (
                    <a 
                      href={contact.linkedinUrl} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="linkedin-link"
                    >
                      ğŸ”— LinkedIn
                    </a>
                  )}
                </div>
              </div>
            </div>
            <button 
              className="select-contact-btn"
              onClick={() => selectContact(contact)}
            >
              {selectedContact?.id === contact.id ? 'âœ“ Selected' : 'Select'}
            </button>
          </div>
        ))}
      </div>
    )}

    {selectedContact && (
      <div className="selected-contact-banner">
        <p>
          âœ‰ï¸ Sending to: <strong>{selectedContact.name}</strong> ({selectedContact.email})
        </p>
        <button 
          className="copy-email-address-btn"
          onClick={() => navigator.clipboard.writeText(selectedContact.email)}
        >
          ğŸ“‹ Copy Email Address
        </button>
      </div>
    )}
  </div>
)}
