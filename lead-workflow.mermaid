graph TD
    %% LEAD SOURCES
    A[ğŸŒ Single Website] -->|Manual add| B[leads table<br/>status: new]
    A2[ğŸ“‹ Bulk Add] -->|Multiple websites| B
    A3[ğŸ“„ CSV Import] -->|Bulk import| B
    A4[ğŸ” StoreLeads Discovery] -->|Top stores by category| B2[leads table<br/>status: enriched]

    %% ENRICHMENT WATERFALL: StoreLeads â†’ Apollo â†’ Claude
    B -->|Batch 50 domains| C{Step 1:<br/>StoreLeads Bulk API<br/>free, fast}
    C -->|Found| D[Store Data<br/>products, sales, category<br/>country, platform, rank]
    C -->|Not Found| C2{Step 2:<br/>Apollo Org Enrichment<br/>cheap fallback}
    C2 -->|Found| D2[Company Data<br/>revenue, employees<br/>industry, keywords]
    C2 -->|Not Found| C3{Step 3:<br/>Claude AI + Web Search<br/>expensive, thorough}
    C3 -->|Found| D3[AI Research<br/>ICP fit, industry<br/>catalog, HQ, pain points]
    C3 -->|Not Found| E[status: new<br/>unenriched]

    %% ICP SCORING â€” Two models by source
    D --> F{StoreLeads<br/>ICP Scoring}
    F --> G1[âœ… Products â‰¥ 250]
    F --> G2[âœ… Sales â‰¥ $50K/mo]
    F --> G3[âœ… Target Category]
    G1 & G2 & G3 --> H{US/CA + 3/3?}

    D2 --> F2{Apollo<br/>ICP Scoring}
    F2 --> G4[âœ… Revenue â‰¥ $12M/yr]
    F2 --> G5[âœ… Target Category]
    F2 --> G6[âœ… Employees â‰¥ 50]
    G4 & G5 & G6 --> H

    D3 --> H2[Claude assigns<br/>ICP fit directly]
    H2 --> I
    H2 --> J
    H2 --> K

    H -->|Yes| I[ğŸŸ¢ HIGH]
    H -->|US/CA + 2/3<br/>or non-US 2-3/3| J[ğŸŸ¡ MEDIUM]
    H -->|0-1/3| K[ğŸ”´ LOW]

    %% CONTACT MATCHING
    I --> L{Contact Database<br/>509k contacts}
    J --> L
    L -->|Match on domain| M[has_contacts: true]
    L -->|No match| N[has_contacts: false]

    %% APOLLO CONTACT DISCOVERY
    N --> AP{ğŸš€ Apollo API<br/>Contact Discovery}
    AP -->|Step 1: Search| AP1[Search by domain +<br/>senior titles<br/>1 credit]
    AP1 -->|Filter verified emails| AP2[Step 2: Enrich<br/>bulk_match top 3<br/>3 credits]
    AP2 -->|Full name + email| AP3[Add to<br/>contact_database]
    AP3 --> M
    AP2 -->|No results| AP4[âŒ No contacts<br/>status: no_contacts]

    %% OUTREACH FLOW
    M --> O[ğŸ“‹ Step 1: Select Lead<br/>Filter: HIGH + Has Contacts]
    O --> P[âœ¨ Step 2: Generate Email<br/>Claude AI + lead context]
    P --> Q[ğŸ‘¥ Step 3: Find Contacts<br/>Scored by title relevance]

    Q --> R2[ğŸ¯ Marketing Leader â€” 100]
    Q --> R1[ğŸ”¥ Creator/Social â€” 95]
    Q --> R3[ğŸ¯ Digital/Ecommerce â€” 90]
    Q --> R4[ğŸŸ¢ Brand/Content â€” 70]
    Q --> R5[ğŸ‘” Executive â€” 60]
    Q --> R6[ğŸ”µ Mid-Level â€” 30]

    R1 & R2 & R3 & R4 & R5 & R6 --> EV

    %% EMAIL VERIFICATION
    EV{âœ‰ï¸ EmailListVerify<br/>Pre-Send Check}
    EV -->|ok, ok_for_all,<br/>accept_all| S{Send Method}
    EV -->|invalid, email_disabled,<br/>dead_server, syntax_error| EV2[ğŸ—‘ï¸ Remove from<br/>contact_database<br/>Skip to next contact]
    EV -->|API error| S

    S -->|Direct| T[ğŸ“§ Gmail API Send<br/>Instant, no tab switch]
    S -->|Fallback| U[ğŸ“§ Open in Gmail<br/>Compose window]

    T --> V[âœ… Lead: contacted<br/>outreach_log entry]
    U --> V

    %% BOUNCE HANDLING
    V --> W{Bounce Check<br/>Gmail mailer-daemon}
    W -->|Bounced| X[ğŸ—‘ï¸ Remove bad contact<br/>â†©ï¸ Reset lead to enriched]
    W -->|Delivered| RD

    %% REPLY DETECTION
    RD{ğŸ“¬ Reply Check<br/>Gmail inbox scan}
    RD -->|Auto-responder<br/>OOO, auto-reply headers| RD1[ğŸ¤– Filtered out<br/>Ignored]
    RD -->|Real reply| RD2[ğŸ“© Lead: replied<br/>outreach_log.replied_at set]
    RD -->|No reply yet| MC

    %% AGENT AUTOMATION
    MC{ğŸ¤– Agent Automation<br/>Mon-Fri, 9am-5pm EST}
    MC -->|1 contact/company/day<br/>2+ min delay between sends<br/>Daily email budget| O
    MC -->|All contacts emailed| NXT[â¡ï¸ Move to next lead]
    MC -.->|auto_send: false| DR[ğŸ“ Save as Draft<br/>for manual review]

    %% LEAD STATUS LIFECYCLE
    subgraph Status Lifecycle
        LS1[new] --> LS2[enriched]
        LS2 --> LS3[contacted]
        LS3 --> LS4[replied]
        LS2 -.-> LS5[no_contacts]
    end

    %% STYLING
    style I fill:#166534,color:#fff
    style J fill:#854d0e,color:#fff
    style K fill:#991b1b,color:#fff
    style T fill:#6d28d9,color:#fff
    style V fill:#166534,color:#fff
    style X fill:#991b1b,color:#fff
    style RD2 fill:#166534,color:#fff
    style NXT fill:#166534,color:#fff
    style B fill:#1e293b,color:#fff
    style B2 fill:#1e293b,color:#fff
    style AP fill:#1e40af,color:#fff
    style AP3 fill:#1e40af,color:#fff
    style AP4 fill:#991b1b,color:#fff
    style EV fill:#7c3aed,color:#fff
    style EV2 fill:#991b1b,color:#fff
    style MC fill:#6d28d9,color:#fff
    style C2 fill:#1e40af,color:#fff
    style C3 fill:#7c3aed,color:#fff
    style D2 fill:#1e40af,color:#fff
    style D3 fill:#7c3aed,color:#fff
    style RD fill:#6d28d9,color:#fff
    style RD1 fill:#854d0e,color:#fff
    style DR fill:#854d0e,color:#fff
    style LS1 fill:#1e293b,color:#fff
    style LS2 fill:#1e40af,color:#fff
    style LS3 fill:#6d28d9,color:#fff
    style LS4 fill:#166534,color:#fff
    style LS5 fill:#991b1b,color:#fff
    style F2 fill:#1e40af,color:#fff
    style H2 fill:#7c3aed,color:#fff
